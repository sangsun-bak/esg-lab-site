<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>발간저널(아카이브) | Social Business Review</title>
  <link rel="stylesheet" href="/assets/styles.css">
  <style>
    /* 최소 변경: 페이지 내부 전용 스타일만 추가 */
    .archive-wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .vol-block{margin:28px 0 36px 0}
    .vol-head{display:flex;align-items:baseline;gap:12px;margin:0 0 12px 0;border-bottom:1px solid #eee;padding-bottom:8px}
    .vol-head h2{margin:0;font-size:1.25rem}
    .vol-head .meta{color:#666;font-size:.95rem}
    .paper-list{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
      gap:18px;
      align-items:start;
    }
    .paper-card{border:1px solid #eee;border-radius:14px;padding:16px;background:#fff}
    .paper-card h4{margin:.2rem 0 .4rem 0;font-size:1.05rem;line-height:1.5}
    .paper-card .authors{font-size:.95rem;color:#555;margin-bottom:4px}
    .paper-card .extra{font-size:.9rem;color:#777}
    .paper-card .actions{margin-top:8px}
    .paper-card .actions a{display:inline-block;margin-right:12px;font-size:.92rem;text-decoration:none;border-bottom:1px dashed #aaa}
    .muted{color:#666}
    /* 작은 화면에서 보기 좋게 */
    @media (max-width: 480px){
      .paper-list{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
  <main class="archive-wrap" id="archive-app">
    <header>
      <h1>발간저널(아카이브)</h1>
    </header>
    <div id="pubs-archive"></div>
  </main>

  <script>
  (function(){
    const root = document.getElementById('pubs-archive');

    function text(v){ return (v==null?'':String(v)).trim(); }
    function tryNum(v){
      const n = Number((v||'').toString().replace(/[^0-9.]/g,''));
      return Number.isFinite(n) ? n : null;
    }
    function authorsToText(auth){
      if (!auth) return '';
      if (Array.isArray(auth)){
        return auth.map(a => (typeof a==='string'?a:(a.name||''))).filter(Boolean).join(', ');
      }
      return String(auth||'');
    }
    function buildGroupKey(x){
      const v = text(x.volume||x.vol);
      const i = text(x.issue||x.no||x.number);
      const y = text(x.year||x.date||'');
      return [v,i,y].join('|');
    }
    function groupTitle(v,i,y){
      const parts = [];
      if (v) parts.push(`Vol.${v}`);
      if (i) parts.push(`No.${i}`);
      const head = parts.length ? parts.join(' ') : '기타';
      return y ? `${head} (${y})` : head;
    }
    function sortGroupsDesc(a,b){
      // Sort by year desc, volume desc, issue desc (numbers when possible)
      const [va,ia,ya] = a.key.split('|');
      const [vb,ib,yb] = b.key.split('|');
      const nyA = tryNum(ya) ?? -1, nyB = tryNum(yb) ?? -1;
      if (nyA !== nyB) return nyB - nyA;
      const nvA = tryNum(va) ?? -1, nvB = tryNum(vb) ?? -1;
      if (nvA !== nvB) return nvB - nvA;
      const niA = tryNum(ia) ?? -1, niB = tryNum(ib) ?? -1;
      return niB - niA;
    }
    function render(entries){
      if (!root) return;
      root.innerHTML = '';
      // 1) 그룹화
      const map = new Map();
      entries.forEach(it => {
        const key = buildGroupKey(it);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(it);
      });
      // 2) 정렬 & 그리기
      const groups = Array.from(map.entries()).map(([key, items])=>({key, items}));
      groups.sort(sortGroupsDesc);
      groups.forEach(g => {
        const [v,i,y] = g.key.split('|');
        const block = document.createElement('section');
        block.className = 'vol-block';
        block.innerHTML = `
          <div class="vol-head">
            <h2>${groupTitle(v,i,y)}</h2>
            <div class="meta">${g.items.length}편</div>
          </div>
          <div class="paper-list"></div>
        `;
        const list = block.querySelector('.paper-list');
        g.items.forEach(it => {
          const title = text(it.title || it.paper_title || '제목 미정');
          const authors = authorsToText(it.authors);
          const doi = text(it.doi);
          const year = text(it.year);
          const pdf = text(it.pdf || it.file || (it.attachments && it.attachments[0] && it.attachments[0].url));
          const card = document.createElement('article');
          card.className = 'paper-card';
          card.innerHTML = `
            <h4>${title}</h4>
            ${authors ? `<div class="authors">${authors}</div>` : ''}
            <div class="extra">
              ${doi ? `DOI: <span>${doi}</span>` : ''}
            </div>
            <div class="actions">
              ${pdf ? `<a href="${pdf}" target="_blank" rel="noopener">PDF</a>` : ''}
            </div>
          `;
          list.appendChild(card);
        });
        root.appendChild(block);
      });
    }

    async function init(){
      // 0) 기존에 하드코딩된 데모 텍스트 제거
      // (이 페이지 파일에서 이미 제거했지만, CDN 캐시 등에 대비해 남아 있으면 지움)
      Array.from(document.querySelectorAll('h2,h3,p')).forEach(n=>{
        const t = (n.textContent||'').replace(/\s+/g,' ').trim();
        if (/발간논문.*Archive/i.test(t) || /Vol\.?\s*1.*No\.?\s*1/i.test(t)){
          n.remove();
        }
      });

      // 1) 데이터 로드 (최우선: pubs.json)
      try{
        const res = await fetch('/assets/data/pubs.json', { cache:'no-store' });
        if (res.ok){
          const data = await res.json();
          const entries = (data && (data.entries || data)) || [];
          if (Array.isArray(entries) && entries.length){
            render(entries);
            return;
          }
        }
      }catch(e){/*silent*/}

      // 2) 폴백: 페이지 내 기존 DOM 항목 존재 시, 가능한 정보만 수집해서 간이 그룹 렌더
      const nodes = Array.from(document.querySelectorAll('article.paper'));
      if (nodes.length){
        const entries = nodes.map(n => ({
          title: (n.querySelector('h4, h3, .title')||{}).textContent || '',
          authors: (n.querySelector('.authors, .byline')||{}).textContent || '',
          pdf: (n.querySelector('a[href$=".pdf"]')||{}).getAttribute ? (n.querySelector('a[href$=".pdf"]').getAttribute('href') || '') : ''
        }));
        render(entries);
      }
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init, { once:true });
    } else {
      init();
    }
  })();
  </script>
</body>
</html>
